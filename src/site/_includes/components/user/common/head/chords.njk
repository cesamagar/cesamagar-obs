<script src="[https://unpkg.com/chordsheetjs/dist/chordsheetjs.umd.js](https://unpkg.com/chordsheetjs/dist/chordsheetjs.umd.js)"></script>

<script>
(function() {
    function renderizarCanciones() {
        // Buscamos los bloques que Obsidian marca como "chords"
        // Digital Garden suele generar: <pre class="language-chords"><code class="language-chords">
        const bloques = document.querySelectorAll('pre[class*="language-chords"], code[class*="language-chords"]');

        bloques.forEach((el, index) => {
            // Si ya lo hemos procesado o es un contenedor interno, saltamos
            if (el.dataset.musicParsed === "true" || el.tagName === 'CODE' && el.parentElement.tagName === 'PRE' && el.parentElement.dataset.musicParsed === "true") return;

            const contenidoRaw = el.innerText.trim();
            if (!contenidoRaw) return;

            try {
                // Usamos el Parser de ChordPro (específico para tu formato)
                const parser = new ChordSheetJS.ChordProParser();
                let cancion = parser.parse(contenidoRaw);
                const formateador = new ChordSheetJS.HtmlTableFormatter();

                // Creamos el contenedor visual
                const contenedor = document.createElement('div');
                contenedor.className = 'cancion-interactiva';
                el.dataset.musicParsed = "true";

                const dibujar = (s) => formateador.format(s);

                contenedor.innerHTML = `
                    <div class="controles-musica">
                        <button class="btn-tono" id="subir-${index}">+1 Tono</button>
                        <button class="btn-tono" id="bajar-${index}">-1 Tono</button>
                        <span class="info-tono">Interactivo ChordPro</span>
                    </div>
                    <div id="visor-${index}" class="visor-musica">${dibujar(cancion)}</div>
                `;

                // Reemplazamos el bloque original
                const objetivo = el.tagName === 'CODE' ? el.parentElement : el;
                objetivo.replaceWith(contenedor);

                // Lógica de botones
                contenedor.querySelector(`#subir-${index}`).onclick = (e) => {
                    e.preventDefault();
                    cancion = cancion.transpose(1);
                    contenedor.querySelector(`#visor-${index}`).innerHTML = dibujar(cancion);
                };
                contenedor.querySelector(`#bajar-${index}`).onclick = (e) => {
                    e.preventDefault();
                    cancion = cancion.transpose(-1);
                    contenedor.querySelector(`#visor-${index}`).innerHTML = dibujar(cancion);
                };

            } catch (error) {
                console.error("Error procesando ChordPro:", error);
            }
        });
    }

    // Ejecutar al cargar la página
    window.addEventListener('load', renderizarCanciones);
    
    // Ejecutar cada vez que el contenido de la nota cambie (para navegación SPA de Digital Garden)
    const observer = new MutationObserver(renderizarCanciones);
    observer.observe(document.body, { childList: true, subtree: true });
    
    // Ejecución de respaldo
    setTimeout(renderizarCanciones, 1000);
})();
</script>

<style>
    .cancion-interactiva {
        background: #1a1a1b !important;
        color: #d7dadc !important;
        padding: 20px !important;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid #343536;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .controles-musica {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        align-items: center;
        border-bottom: 1px solid #343536;
        padding-bottom: 10px;
    }
    .btn-tono {
        background: #343536;
        color: white;
        border: 1px solid #474748;
        padding: 4px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }
    .btn-tono:hover { background: #474748; }
    .info-tono { font-size: 11px; color: #818384; text-transform: uppercase; letter-spacing: 1px; }
    
    /* Estilos del renderizado de la canción */
    .visor-musica table { border-collapse: collapse; border: none !important; }
    .visor-musica td { padding: 0 2px !important; border: none !important; vertical-align: bottom; }
    .visor-musica .chord { 
        color: #ffb74d !important; /* Naranja para los acordes */
        font-weight: bold; 
        height: 1.4em; 
        display: block;
    }
    .visor-musica .lyrics { color: #d7dadc; white-space: pre; }
</style>
