<script src="https://unpkg.com/chordsheetjs@13.0.1/lib/bundle.js"></script>

<script>
(function() {
    function aplicarTransformacion() {
        if (typeof ChordSheetJS === 'undefined') return;

        const bloques = document.querySelectorAll('pre');
        
        bloques.forEach((bloque, i) => {
            if (bloque.dataset.renderizado === "true") return;

            const texto = bloque.innerText.trim();
            if (texto.includes('[') && texto.includes(']')) {
                try {
                    const parser = new ChordSheetJS.ChordProParser();
                    let cancion = parser.parse(texto);
                    const formateador = new ChordSheetJS.HtmlTableFormatter();
                    
                    bloque.dataset.renderizado = "true";
                    const contenedor = document.createElement('div');
                    contenedor.className = 'chord-interactive-container';
                    
                    const render = (s) => formateador.format(s);

                    contenedor.innerHTML = `
                        <div class="chord-controls">
                            <button id="up-${i}" class="chord-btn">+1 Tono</button>
                            <button id="down-${i}" class="chord-btn">-1 Tono</button>
                            <span class="chord-badge">MODO INTERACTIVO</span>
                        </div>
                        <div id="visor-${i}" class="chord-render-area">${render(cancion)}</div>
                    `;

                    bloque.replaceWith(contenedor);

                    contenedor.querySelector(`#up-${i}`).onclick = (e) => {
                        e.preventDefault();
                        cancion = cancion.transpose(1);
                        contenedor.querySelector(`#visor-${i}`).innerHTML = render(cancion);
                    };
                    contenedor.querySelector(`#down-${i}`).onclick = (e) => {
                        e.preventDefault();
                        cancion = cancion.transpose(-1);
                        contenedor.querySelector(`#visor-${i}`).innerHTML = render(cancion);
                    };
                } catch (err) { console.error("Error:", err); }
            }
        });
    }
    setInterval(aplicarTransformacion, 1000);
})();
</script>

<style>
    /* 1. Contenedor principal */
    .chord-interactive-container {
        background: #1e1e1e !important;
        padding: 20px !important;
        border-radius: 10px;
        border: 1px solid #333;
        margin: 25px 0;
        overflow-x: auto;
    }

    /* 2. Botones y cabecera */
    .chord-controls { 
        margin-bottom: 20px; 
        display: flex; 
        gap: 12px; 
        align-items: center;
        border-bottom: 1px solid #333;
        padding-bottom: 12px;
    }
    .chord-btn { 
        background: #333 !important; color: #fff !important; border: 1px solid #555 !important; 
        padding: 6px 12px !important; border-radius: 5px !important; cursor: pointer; font-size: 13px;
    }
    .chord-badge { font-size: 10px; color: #666; font-weight: bold; letter-spacing: 1px; }

    /* 3. RESET DE TABLA (Esto arregla la alineación) */
    .chord-render-area table { 
        border-collapse: collapse !important; 
        border: none !important; 
        width: auto !important; 
        margin: 0 !important;
        display: table !important; /* Evita que se comporte como bloque */
    }
    .chord-render-area tr { 
        border: none !important; 
        display: table-row !important; 
    }
    .chord-render-area td { 
        padding: 0 1px !important; 
        border: none !important; 
        line-height: 1 !important; /* Muy importante para que no se separen */
        text-align: left !important;
        display: table-cell !important;
    }

    /* 4. Tipografía y colores */
    .chord-render-area .chord { 
        color: #4db6ac !important; 
        font-weight: bold !important; 
        font-family: 'Courier New', Courier, monospace !important;
        font-size: 14px !important;
        display: inline-block !important; /* Cambiado de block a inline-block */
        margin-bottom: 2px !important;
    }
    .chord-render-area .lyrics { 
        font-family: 'Courier New', Courier, monospace !important; 
        white-space: pre !important; 
        color: #ccc !important;
        font-size: 14px !important;
    }

    /* Ajuste para los títulos internos de ChordPro {title:} */
    .chord-render-area .title { 
        font-size: 1.5em; 
        color: #ff7043; 
        margin-bottom: 10px; 
        display: block;
        font-weight: bold;
    }
</style>
