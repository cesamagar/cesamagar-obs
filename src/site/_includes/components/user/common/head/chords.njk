<script src="https://unpkg.com/chordsheetjs/dist/chordsheetjs.umd.js"></script>

<script>
(function() {
    function transformar() {
        console.log("--- RASTREADOR DE ACORDES ACTIVO ---");
        
        // 1. Buscamos TODOS los bloques de código de la página
        const todosLosBloques = document.querySelectorAll('pre');
        console.log("Bloques detectados en total:", todosLosBloques.length);

        todosLosBloques.forEach((bloque, i) => {
            const texto = bloque.innerText;
            
            // 2. Si el bloque ya está procesado o está vacío, saltamos
            if (bloque.dataset.musicDone === "true" || !texto.trim()) return;

            // 3. ¿Parece una canción? (Buscamos si tiene [Acordes] o patrones de música)
            const tieneCorchetes = texto.includes('[') && texto.includes(']');
            const tieneClaseChords = bloque.innerHTML.includes('chords') || bloque.className.includes('chords');

            if (tieneCorchetes || tieneClaseChords) {
                console.log("¡CANCION ENCONTRADA en el bloque!", i);
                try {
                    const parser = tieneCorchetes ? 
                        new ChordSheetJS.ChordProParser() : 
                        new ChordSheetJS.ChordsOverWordsParser();
                    
                    let song = parser.parse(texto);
                    const formatter = new ChordSheetJS.HtmlTableFormatter();
                    bloque.dataset.musicDone = "true";

                    const div = document.createElement('div');
                    div.style.cssText = "background:#1e1e1e; color:#eee; padding:20px; border-radius:10px; margin:20px 0; border:1px solid #444;";
                    
                    const dibujar = (s) => formatter.format(s);

                    div.innerHTML = `
                        <div style="margin-bottom:15px; display:flex; gap:10px;">
                            <button id="u-${i}" style="padding:5px 12px; background:#333; color:white; border:1px solid #555; cursor:pointer;">+1 Tono</button>
                            <button id="d-${i}" style="padding:5px 12px; background:#333; color:white; border:1px solid #555; cursor:pointer;">-1 Tono</button>
                        </div>
                        <div id="c-${i}" class="musica-render">${dibujar(song)}</div>
                    `;

                    bloque.replaceWith(div);

                    div.querySelector(`#u-${i}`).onclick = () => {
                        song = song.transpose(1);
                        div.querySelector(`#c-${i}`).innerHTML = dibujar(song);
                    };
                    div.querySelector(`#d-${i}`).onclick = () => {
                        song = song.transpose(-1);
                        div.querySelector(`#c-${i}`).innerHTML = dibujar(song);
                    };
                } catch (err) {
                    console.error("Error al renderizar:", err);
                }
            }
        });
    }

    // Intentamos ejecutar en varios momentos para asegurar el tiro
    window.addEventListener('load', transformar);
    setTimeout(transformar, 500);
    setTimeout(transformar, 2000);
})();
</script>

<style>
    .musica-render .chord { color: #5db9ff !important; font-weight: bold; height: 1.3em; display: block; }
    .musica-render .lyrics { font-family: 'Courier New', monospace; white-space: pre; color: #ccc; }
    .musica-render table { border-spacing: 0; margin-bottom: 5px; border:none; }
    .musica-render td { padding: 0 2px; border:none; }
</style>
