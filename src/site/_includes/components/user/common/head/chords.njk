<script src="https://unpkg.com/chordsheetjs/dist/chordsheetjs.umd.js"></script>

<script>
(function() {
    function renderChords() {
        // 1. Buscamos TODOS los bloques de código de la página sin excepción
        const elements = document.querySelectorAll('pre');
        
        elements.forEach((pre) => {
            // Evitar procesar lo mismo varias veces
            if (pre.dataset.chordified === "true") return;

            const text = pre.innerText.trim();

            // 2. ¿Tiene pinta de canción? 
            // Buscamos etiquetas típicas de ChordPro o la presencia de corchetes
            const isChordPro = text.includes('[') && text.includes(']') || text.includes('{title:');

            if (isChordPro) {
                console.log("¡Canción detectada por contenido!");
                try {
                    const parser = new ChordSheetJS.ChordProParser();
                    let song = parser.parse(text);
                    const formatter = new ChordSheetJS.HtmlTableFormatter();
                    
                    pre.dataset.chordified = "true";
                    const container = document.createElement('div');
                    container.className = 'chord-sheet-wrapper';

                    const doRender = (s) => formatter.format(s);

                    container.innerHTML = `
                        <div class="chord-toolbar">
                            <button class="t-btn" id="up">Tono +1</button>
                            <button class="t-btn" id="down">Tono -1</button>
                            <span class="t-badge">MODO INTERACTIVO</span>
                        </div>
                        <div class="chord-render-area">${doRender(song)}</div>
                    `;

                    pre.replaceWith(container);

                    container.querySelector('#up').onclick = () => {
                        song = song.transpose(1);
                        container.querySelector('.chord-render-area').innerHTML = doRender(song);
                    };
                    container.querySelector('#down').onclick = () => {
                        song = song.transpose(-1);
                        container.querySelector('.chord-render-area').innerHTML = doRender(song);
                    };

                } catch (e) {
                    console.error("Error al parsear canción:", e);
                }
            }
        });
    }

    // Ejecutar en bucle corto al principio para pillar la carga de Vercel
    window.addEventListener('load', renderChords);
    setInterval(renderChords, 1500); // Re-intento cada 1.5s por si la web es lenta
})();
</script>

<style>
    .chord-sheet-wrapper {
        background: #111 !important;
        color: #eee !important;
        padding: 20px !important;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid #444;
        overflow-x: auto;
    }
    .chord-toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
    }
    .t-btn {
        background: #333;
        color: #fff;
        border: 1px solid #555;
        padding: 4px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    .t-badge { font-size: 10px; color: #777; font-weight: bold; }
    
    /* Estilos para que los acordes NO se muevan */
    .chord-render-area table { border-collapse: collapse; border: none !important; width: auto !important; }
    .chord-render-area td { padding: 0 1px !important; border: none !important; }
    .chord-render-area .chord { 
        color: #4da6ff !important; 
        font-weight: bold; 
        font-family: monospace;
        height: 1.4em;
        display: block;
    }
    .chord-render-area .lyrics { 
        font-family: monospace; 
        white-space: pre;
        color: #ccc;
    }
</style>
