<script src="https://unpkg.com/chordsheetjs@13.0.1/lib/bundle.js"></script>

<script>
(function() {
    function renderizar() {
        if (typeof ChordSheetJS === 'undefined') return;

        const bloques = document.querySelectorAll('pre');
        bloques.forEach((bloque, i) => {
            if (bloque.dataset.renderizado === "true") return;

            const texto = bloque.innerText.trim();
            // Detectamos si es formato ChordPro por los corchetes
            if (texto.includes('[') && texto.includes(']')) {
                try {
                    const parser = new ChordSheetJS.ChordProParser();
                    let cancion = parser.parse(texto);
                    const formateador = new ChordSheetJS.HtmlTableFormatter();
                    
                    bloque.dataset.renderizado = "true";
                    const contenedor = document.createElement('div');
                    contenedor.className = 'chord-sheet-container';
                    
                    const dibujar = (s) => formateador.format(s);

                    contenedor.innerHTML = `
                        <div class="chord-toolbar">
                            <button id="up-${i}" class="c-btn">+1 Tono</button>
                            <button id="down-${i}" class="c-btn">-1 Tono</button>
                            <span class="c-tag">MODO INTERACTIVO</span>
                        </div>
                        <div id="visor-${i}" class="chord-render-area">${dibujar(cancion)}</div>
                    `;

                    bloque.replaceWith(contenedor);

                    contenedor.querySelector(`#up-${i}`).onclick = (e) => {
                        e.preventDefault();
                        cancion = cancion.transpose(1);
                        contenedor.querySelector(`#visor-${i}`).innerHTML = dibujar(cancion);
                    };
                    contenedor.querySelector(`#down-${i}`).onclick = (e) => {
                        e.preventDefault();
                        cancion = cancion.transpose(-1);
                        contenedor.querySelector(`#visor-${i}`).innerHTML = dibujar(cancion);
                    };
                } catch (err) { console.error("Error:", err); }
            }
        });
    }
    // Ejecutar cada segundo para pillar cambios de página
    setInterval(renderizar, 1000);
})();
</script>

<style>
    /* 1. Reset total del contenedor */
    .chord-sheet-container {
        background: #1e1e1e !important;
        padding: 20px !important;
        border-radius: 8px;
        border: 1px solid #333;
        margin: 20px 0;
        overflow-x: auto !important;
    }

    /* 2. Toolbar */
    .chord-toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .c-btn { background: #333 !important; color: white !important; border: 1px solid #555 !important; padding: 5px 12px !important; border-radius: 4px !important; cursor: pointer; font-size: 12px; }
    .c-tag { font-size: 9px; color: #666; font-weight: bold; }

    /* 3. ARREGLO DE ALINEACIÓN (CRÍTICO) */
    /* Forzamos que la tabla no ocupe el 100% y que las celdas no tengan padding */
    .chord-render-area table {
        border-collapse: collapse !important;
        border: none !important;
        margin: 0 !important;
        width: auto !important; /* Evita que la tabla se estire y desplace acordes */
        table-layout: auto !important;
    }

    .chord-render-area tr {
        border: none !important;
        background: none !important;
    }

    .chord-render-area td {
        padding: 0 !important;
        border: none !important;
        vertical-align: bottom !important; /* Alinea letra a la base */
        text-align: left !important;
        min-width: 0.2em; /* Mantiene espacio mínimo */
    }

    /* 4. ESTILO DE ACORDE Y LETRA */
    /* Forzamos que el acorde esté justo encima de la letra en la misma celda */
    .chord-render-area .chord {
        color: #4db6ac !important; /* Turquesa de tus botones */
        font-weight: bold !important;
        font-family: 'Courier New', Courier, monospace !important;
        font-size: 14px !important;
        display: block !important; /* El acorde ocupa su propia línea dentro de la celda */
        height: 1.3em !important;
        line-height: 1.3em !important;
        margin: 0 !important;
    }

    .chord-render-area .lyrics {
        color: #ccc !important;
        font-family: 'Courier New', Courier, monospace !important;
        font-size: 14px !important;
        display: block !important; /* La letra ocupa su propia línea debajo del acorde */
        line-height: 1.3em !important;
        white-space: pre !important; /* MANTIENE LOS ESPACIOS CLAVE */
        margin: 0 !important;
    }

    /* Manejo de celdas que solo tienen letra (sin acorde arriba) */
    .chord-render-area td:not(:has(.chord)) .lyrics {
        margin-top: 1.3em !important; /* Empuja la letra hacia abajo para alinearla con el resto */
    }
</style>
