<script src="https://unpkg.com/chordsheetjs@13.0.1/lib/bundle.js"></script>

<script>
(function() {
    function transformar() {
        if (typeof ChordSheetJS === 'undefined') return;

        const bloques = document.querySelectorAll('pre');
        bloques.forEach((bloque, i) => {
            if (bloque.dataset.renderizado === "true") return;

            const texto = bloque.innerText.trim();
            if (texto.includes('[') && texto.includes(']')) {
                try {
                    const parser = new ChordSheetJS.ChordProParser();
                    let cancion = parser.parse(texto);
                    const formateador = new ChordSheetJS.HtmlTableFormatter();
                    
                    bloque.dataset.renderizado = "true";
                    const contenedor = document.createElement('div');
                    contenedor.className = 'chord-sheet-wrapper';
                    
                    const dibujar = (s) => formateador.format(s);

                    contenedor.innerHTML = `
                        <div class="chord-toolbar">
                            <button id="up-${i}" class="t-btn">+1 Tono</button>
                            <button id="down-${i}" class="t-btn">-1 Tono</button>
                            <span class="t-tag">INTERACTIVO</span>
                        </div>
                        <div id="visor-${i}" class="chord-render-area">${dibujar(cancion)}</div>
                    `;

                    bloque.replaceWith(contenedor);

                    contenedor.querySelector(`#up-${i}`).onclick = (e) => {
                        e.preventDefault();
                        cancion = cancion.transpose(1);
                        contenedor.querySelector(`#visor-${i}`).innerHTML = dibujar(cancion);
                    };
                    contenedor.querySelector(`#down-${i}`).onclick = (e) => {
                        e.preventDefault();
                        cancion = cancion.transpose(-1);
                        contenedor.querySelector(`#visor-${i}`).innerHTML = dibujar(cancion);
                    };
                } catch (err) { console.error("Error:", err); }
            }
        });
    }
    setInterval(transformar, 1000);
})();
</script>

<style>
    /* 1. Contenedor y Toolbar */
    .chord-sheet-wrapper {
        background: #1e1e1e !important;
        padding: 20px !important;
        border-radius: 8px;
        border: 1px solid #333;
        margin: 20px 0;
        overflow-x: auto; /* Permite scroll si la línea es larga */
    }
    .chord-toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .t-btn { background: #333 !important; color: white !important; border: 1px solid #555 !important; padding: 5px 12px !important; border-radius: 4px !important; cursor: pointer; font-size: 12px; }
    .t-tag { font-size: 9px; color: #666; font-weight: bold; }

    /* 2. ARREGLO DE ALINEACIÓN (CRÍTICO) */
    .chord-render-area table {
        display: inline-table !important; /* Mantiene la tabla compacta */
        border-collapse: collapse !important;
        border: none !important;
        margin: 0 !important;
        line-height: 1 !important;
    }

    .chord-render-area tr {
        display: flex !important; /* Convierte la fila en un flexbox horizontal */
        flex-wrap: wrap !important;
        border: none !important;
        margin-bottom: 15px !important; /* Espacio entre líneas de la canción */
    }

    .chord-render-area td {
        display: inline-flex !important;
        flex-direction: column !important; /* Apila acorde arriba y letra abajo */
        padding: 0 !important;
        border: none !important;
        min-width: 0.5em; /* Evita que celdas vacías colapsen */
    }

    /* 3. Estilos de Texto */
    .chord-render-area .chord {
        color: #4db6ac !important; /* Turquesa */
        font-weight: bold !important;
        font-family: 'Courier New', monospace !important;
        font-size: 14px !important;
        height: 1.4em !important; /* Espacio fijo para el acorde */
        visibility: visible !important;
        display: block !important;
    }

    .chord-render-area .lyrics {
        color: #ccc !important;
        font-family: 'Courier New', monospace !important;
        font-size: 14px !important;
        white-space: pre !important; /* Mantiene los espacios de la letra */
        display: block !important;
        margin-top: 2px !important;
    }

    /* Manejo de espacios en blanco en la letra */
    .chord-render-area td:has(.lyrics:empty) {
        min-width: 1ch;
    }
</style>
