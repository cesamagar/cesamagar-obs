<script src="/static/chordsheetjs.js"></script>

<script>
(function() {
    function inicializar() {
        // Verificamos si la librería ya está en la memoria del navegador
        if (typeof ChordSheetJS === 'undefined') {
            console.log("Buscando librería en /static/...");
            return;
        }

        const bloques = document.querySelectorAll('pre');
        
        bloques.forEach((bloque, i) => {
            if (bloque.dataset.musicDone === "true") return;

            const texto = bloque.innerText.trim();
            // Detectamos si el bloque tiene el formato de acordes [C]
            if (texto.includes('[') && texto.includes(']')) {
                try {
                    const parser = new ChordSheetJS.ChordProParser();
                    let cancion = parser.parse(texto);
                    const formateador = new ChordSheetJS.HtmlTableFormatter();
                    
                    bloque.dataset.musicDone = "true";
                    const contenedor = document.createElement('div');
                    contenedor.className = 'chord-interactive-box';
                    
                    const render = (s) => formateador.format(s);

                    contenedor.innerHTML = `
                        <div class="chord-btns">
                            <button id="up-${i}" class="m-btn">Tono +1</button>
                            <button id="down-${i}" class="m-btn">Tono -1</button>
                        </div>
                        <div id="render-${i}" class="m-render">${render(cancion)}</div>
                    `;

                    bloque.replaceWith(contenedor);

                    contenedor.querySelector(`#up-${i}`).onclick = (e) => {
                        e.preventDefault();
                        cancion = cancion.transpose(1);
                        contenedor.querySelector(`#render-${i}`).innerHTML = render(cancion);
                    };
                    contenedor.querySelector(`#down-${i}`).onclick = (e) => {
                        e.preventDefault();
                        cancion = cancion.transpose(-1);
                        contenedor.querySelector(`#render-${i}`).innerHTML = render(cancion);
                    };
                } catch (err) {
                    console.error("Error en la canción:", err);
                }
            }
        });
    }

    // Revisar cada segundo por si la página carga lento
    setInterval(inicializar, 1000);
})();
</script>

<style>
    .chord-interactive-box {
        background: #1e1e1e !important;
        padding: 20px !important;
        border-radius: 8px;
        border: 1px solid #333;
        margin: 20px 0;
    }
    .chord-btns { margin-bottom: 15px; display: flex; gap: 10px; }
    .m-btn { 
        background: #333; color: #fff; border: 1px solid #555; 
        padding: 6px 12px; border-radius: 4px; cursor: pointer;
    }
    .m-render .chord { color: #4db6ac !important; font-weight: bold; display: block; height: 1.4em; }
    .m-render .lyrics { font-family: monospace; white-space: pre; color: #ccc; }
    .m-render table { border-collapse: collapse !important; border: none !important; }
    .m-render td { padding: 0 2px !important; border: none !important; }
</style>
