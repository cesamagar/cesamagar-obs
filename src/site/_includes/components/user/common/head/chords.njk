<script src="https://unpkg.com/chordsheetjs@latest/dist/chordsheetjs.umd.js"></script>

<script>
(function() {
    function transformarSiEstaListo() {
        // Verificamos si la librería ya cargó en el navegador
        if (typeof ChordSheetJS === 'undefined') {
            console.log("Esperando a que ChordSheetJS cargue...");
            return; // Si no está lista, salimos y esperamos al siguiente ciclo
        }

        const bloques = document.querySelectorAll('pre');
        
        bloques.forEach((pre, i) => {
            if (pre.dataset.musicDone === "true" || !pre.innerText.trim()) return;

            const texto = pre.innerText;
            // Criterio para detectar ChordPro
            const esMusica = texto.includes('[') && texto.includes(']') || texto.includes('{title:');

            if (esMusica) {
                console.log("¡Transformando canción encontrada!");
                try {
                    // Usamos el parser de ChordPro
                    const parser = new ChordSheetJS.ChordProParser();
                    let song = parser.parse(texto);
                    const formatter = new ChordSheetJS.HtmlTableFormatter();
                    
                    pre.dataset.musicDone = "true";
                    const div = document.createElement('div');
                    div.className = 'chord-sheet-container';
                    
                    const dibujar = (s) => formatter.format(s);

                    div.innerHTML = `
                        <div class="chord-controls">
                            <button id="up-${i}" class="c-btn">+1 Tono</button>
                            <button id="down-${i}" class="c-btn">-1 Tono</button>
                            <span class="c-tag">INTERACTIVO</span>
                        </div>
                        <div id="canvas-${i}" class="c-render">${dibujar(song)}</div>
                    `;

                    pre.replaceWith(div);

                    div.querySelector(`#up-${i}`).onclick = () => {
                        song = song.transpose(1);
                        div.querySelector(`#canvas-${i}`).innerHTML = dibujar(song);
                    };
                    div.querySelector(`#down-${i}`).onclick = () => {
                        song = song.transpose(-1);
                        div.querySelector(`#canvas-${i}`).innerHTML = dibujar(song);
                    };
                } catch (err) {
                    console.error("Fallo al procesar acordes:", err);
                }
            }
        });
    }

    // Ejecutamos el rastreador cada segundo para asegurar que pille la librería y el contenido
    setInterval(transformarSiEstaListo, 1000);
})();
</script>

<style>
    .chord-sheet-container {
        background: #181818 !important;
        color: #e0e0e0 !important;
        padding: 20px !important;
        border-radius: 12px;
        margin: 25px 0;
        border: 1px solid #333;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .chord-controls {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        align-items: center;
        border-bottom: 1px solid #333;
        padding-bottom: 12px;
    }
    .c-btn {
        background: #2a2a2a;
        color: #fff;
        border: 1px solid #444;
        padding: 6px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
    }
    .c-btn:hover { background: #404040; border-color: #666; }
    .c-tag { font-size: 10px; color: #666; font-weight: bold; letter-spacing: 1px; }
    
    /* Estilos críticos para mantener los acordes alineados */
    .c-render table { border-collapse: collapse !important; border: none !important; width: auto !important; }
    .c-render td { padding: 0 2px !important; border: none !important; line-height: 1.2; }
    .c-render .chord { 
        color: #4db6ac !important; /* Color turquesa para los acordes */
        font-weight: bold; 
        font-family: 'Courier New', monospace;
        height: 1.5em;
        display: block;
    }
    .c-render .lyrics { 
        font-family: 'Courier New', monospace; 
        white-space: pre;
        color: #bbb;
    }
</style>
