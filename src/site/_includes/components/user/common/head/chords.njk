<script src="https://cdn.jsdelivr.net/npm/chordsheetjs@8.5.1/dist/chordsheetjs.umd.js" crossorigin="anonymous"></script>

<script>
(function() {
    let attempts = 0;

    function init() {
        // Verificamos si la librería ya está disponible en la memoria del navegador
        if (typeof ChordSheetJS !== 'undefined') {
            console.log("¡Librería cargada con éxito!");
            transformarNotas();
            // Activamos un observador por si cambias de página en la web
            const observer = new MutationObserver(transformarNotas);
            observer.observe(document.body, { childList: true, subtree: true });
        } else {
            attempts++;
            if (attempts < 20) { // Reintenta durante 20 segundos
                console.log("Tipo MIME corregido, esperando respuesta del servidor... " + attempts);
                setTimeout(init, 1000);
            } else {
                console.error("Error crítico: No se pudo conectar con el servidor de música.");
            }
        }
    }

    function transformarNotas() {
        const bloques = document.querySelectorAll('pre');
        
        bloques.forEach((pre, i) => {
            if (pre.dataset.musicDone === "true") return;
            
            const texto = pre.innerText;
            // Detectamos si es formato ChordPro por los corchetes
            if (texto.includes('[') && texto.includes(']')) {
                try {
                    const parser = new ChordSheetJS.ChordProParser();
                    let cancion = parser.parse(texto);
                    const formateador = new ChordSheetJS.HtmlTableFormatter();
                    pre.dataset.musicDone = "true";

                    const div = document.createElement('div');
                    div.className = 'cancion-container';
                    const dibujar = (s) => formateador.format(s);

                    div.innerHTML = `
                        <div class="panel-control">
                            <button id="u-${i}" class="btn-t">Subir Tono</button>
                            <button id="d-${i}" class="btn-t">Bajar Tono</button>
                            <span class="tag-musica">MODO INTERACTIVO</span>
                        </div>
                        <div id="v-${i}" class="v-musica">${dibujar(cancion)}</div>
                    `;

                    pre.replaceWith(div);

                    div.querySelector(`#u-${i}`).onclick = () => {
                        cancion = cancion.transpose(1);
                        div.querySelector(`#v-${i}`).innerHTML = dibujar(cancion);
                    };
                    div.querySelector(`#d-${i}`).onclick = () => {
                        cancion = cancion.transpose(-1);
                        div.querySelector(`#v-${i}`).innerHTML = dibujar(cancion);
                    };
                } catch (e) { console.error("Error en renderizado", e); }
            }
        });
    }

    init();
})();
</script>

<style>
    .cancion-container {
        background: #121212 !important;
        color: #efefef !important;
        padding: 20px !important;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid #333;
    }
    .panel-control {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
        border-bottom: 1px solid #222;
        padding-bottom: 10px;
    }
    .btn-t {
        background: #2c2c2c;
        color: white;
        border: 1px solid #444;
        padding: 5px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }
    .btn-t:hover { background: #3d3d3d; }
    .tag-musica { font-size: 10px; color: #666; font-weight: bold; }
    
    /* Ajustes para que no se muevan los acordes */
    .v-musica table { border-collapse: collapse !important; border: none !important; width: auto !important; }
    .v-musica td { padding: 0 2px !important; border: none !important; }
    .v-musica .chord { 
        color: #4db6ac !important; 
        font-weight: bold; 
        height: 1.4em;
        display: block;
        font-family: monospace;
    }
    .v-musica .lyrics { font-family: monospace; white-space: pre; color: #aaa; }
</style>
