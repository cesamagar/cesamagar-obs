<script src="https://unpkg.com/chordsheetjs/dist/chordsheetjs.umd.js"></script>

<script>
(function() {
    function processChords() {
        console.log("Iniciando transformación de acordes...");
        
        // Buscamos cualquier bloque que contenga 'chords' en su clase o lenguaje
        const blocks = document.querySelectorAll('pre code[class*="chords"], pre[class*="chords"], .language-chords');
        
        if (blocks.length === 0) {
            console.log("No se encontraron bloques de acordes en esta página.");
            return;
        }

        blocks.forEach((block, index) => {
            const rawContent = block.innerText.trim();
            // Evitamos procesar el mismo bloque dos veces
            if (block.dataset.processed === "true") return;
            block.dataset.processed = "true";

            try {
                // Detectar si es ChordPro (con []) o Texto Plano (encima de la letra)
                const isChordPro = rawContent.includes('[') && rawContent.includes(']');
                const parser = isChordPro 
                    ? new ChordSheetJS.ChordProParser() 
                    : new ChordSheetJS.ChordsOverWordsParser();
                
                let song = parser.parse(rawContent);
                const formatter = new ChordSheetJS.HtmlTableFormatter();

                const container = document.createElement('div');
                container.style.cssText = "background:#1e1e1e; color:#eee; padding:1.5rem; border-radius:10px; margin:1.5rem 0; border:1px solid #333; overflow-x:auto;";
                
                const render = (s) => formatter.format(s);

                container.innerHTML = `
                    <div style="margin-bottom:1rem; display:flex; gap:10px; align-items:center;">
                        <button id="up-${index}" style="padding:4px 12px; background:#444; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.8rem;">+1 Tono</button>
                        <button id="down-${index}" style="padding:4px 12px; background:#444; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.8rem;">-1 Tono</button>
                        <span style="font-size:0.7rem; color:#888;">(Interactivo)</span>
                    </div>
                    <div id="canvas-${index}" class="chord-rendered-content">${render(song)}</div>
                `;

                // Reemplazamos el bloque original (buscando el contenedor 'pre' más cercano)
                const toReplace = block.closest('pre') || block;
                toReplace.replaceWith(container);

                container.querySelector(`#up-${index}`).onclick = () => {
                    song = song.transpose(1);
                    container.querySelector(`#canvas-${index}`).innerHTML = render(song);
                };
                container.querySelector(`#down-${index}`).onclick = () => {
                    song = song.transpose(-1);
                    container.querySelector(`#canvas-${index}`).innerHTML = render(song);
                };
            } catch (e) {
                console.error("Error al renderizar bloque " + index, e);
            }
        });
    }

    // Ejecución inmediata y con retardo por si el contenido es dinámico
    window.addEventListener('load', processChords);
    document.addEventListener('DOMContentLoaded', processChords);
    setTimeout(processChords, 1000); // Re-intento tras 1 segundo
})();
</script>

<style>
    /* Estilos para asegurar la alineación de acordes */
    .chord-rendered-content .chord { 
        color: #5db9ff !important; 
        font-weight: bold !important; 
        height: 1.3em; 
        display: block; 
    }
    .chord-rendered-content .lyrics { 
        font-family: 'Courier New', monospace !important; 
        white-space: pre !important; 
        color: #ccc; 
    }
    .chord-rendered-content table { 
        border-spacing: 0; 
        margin-bottom: 5px; 
        border: none !important; 
    }
    .chord-rendered-content td { 
        padding: 0 1px !important; 
        border: none !important; 
    }
</style>
