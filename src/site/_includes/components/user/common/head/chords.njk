<script src="/js/chordsheetjs.js"></script>

<script>
(function() {
    function transformarCanciones() {
        // Verificamos que la librería esté cargada en memoria
        if (typeof ChordSheetJS === 'undefined') return;

        // Buscamos todos los bloques de código (pre)
        const bloques = document.querySelectorAll('pre');
        
        bloques.forEach((bloque, i) => {
            if (bloque.dataset.renderizado === "true") return;

            const texto = bloque.innerText.trim();
            // Detectamos si el bloque tiene formato ChordPro (corchetes)
            if (texto.includes('[') && texto.includes(']')) {
                try {
                    const parser = new ChordSheetJS.ChordProParser();
                    let cancion = parser.parse(texto);
                    const formateador = new ChordSheetJS.HtmlTableFormatter();
                    
                    bloque.dataset.renderizado = "true";
                    const contenedor = document.createElement('div');
                    contenedor.className = 'chord-interactive-container';
                    
                    const dibujar = (s) => formateador.format(s);

                    contenedor.innerHTML = `
                        <div class="chord-controls">
                            <button id="up-${i}" class="chord-btn">Tono +1</button>
                            <button id="down-${i}" class="chord-btn">Tono -1</button>
                            <span class="chord-label">MODO INTERACTIVO</span>
                        </div>
                        <div id="visor-${i}" class="chord-render-area">${dibujar(cancion)}</div>
                    `;

                    bloque.replaceWith(contenedor);

                    // Eventos de transposición
                    contenedor.querySelector(`#up-${i}`).onclick = (e) => {
                        e.preventDefault();
                        cancion = cancion.transpose(1);
                        contenedor.querySelector(`#visor-${i}`).innerHTML = dibujar(cancion);
                    };
                    contenedor.querySelector(`#down-${i}`).onclick = (e) => {
                        e.preventDefault();
                        cancion = cancion.transpose(-1);
                        contenedor.querySelector(`#visor-${i}`).innerHTML = dibujar(cancion);
                    };
                } catch (err) {
                    console.error("Error al procesar la canción:", err);
                }
            }
        });
    }

    // Ejecutar el rastreador cada segundo para asegurar la interactividad
    setInterval(transformarCanciones, 1000);
})();
</script>

<style>
    .chord-interactive-container {
        background: #1e1e1e !important;
        padding: 18px !important;
        border-radius: 10px;
        border: 1px solid #333;
        margin: 25px 0;
    }
    .chord-controls { 
        margin-bottom: 15px; 
        display: flex; 
        gap: 12px; 
        align-items: center;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
    }
    .chord-btn { 
        background: #333; color: #fff; border: 1px solid #555; 
        padding: 5px 12px; border-radius: 5px; cursor: pointer; 
        font-size: 13px;
    }
    .chord-btn:hover { background: #444; }
    .chord-label { font-size: 10px; color: #666; font-weight: bold; letter-spacing: 1px; }

    /* Renderizado de acordes */
    .chord-render-area .chord { color: #4db6ac !important; font-weight: bold; display: block; height: 1.5em; }
    .chord-render-area .lyrics { font-family: 'Courier New', monospace; white-space: pre; color: #ccc; }
    .chord-render-area table { border-collapse: collapse !important; border: none !important; }
    .chord-render-area td { padding: 0 2px !important; border: none !important; }
</style>
